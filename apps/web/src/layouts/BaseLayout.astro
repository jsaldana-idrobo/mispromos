---
import "../styles/global.css";
import SiteHeader from "../components/layout/SiteHeader.astro";
import SiteFooter from "../components/layout/SiteFooter.astro";

const apiBase =
  import.meta.env.PUBLIC_API_BASE ?? "http://localhost:3000/api/v1";
const title = Astro.props.title ?? "Mis promos";
const containerClass = Astro.props.containerClass ?? "max-w-6xl";
const cookieHeader = Astro.request.headers.get("cookie") ?? "";
const hasAuthCookie = cookieHeader.includes("auth=");
---

<!doctype html>
<html lang="es" data-authenticated={hasAuthCookie ? "true" : "false"}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <style>
      html[data-auth-loading="true"] [data-nav-login],
      html[data-auth-loading="true"] [data-nav-register],
      html[data-auth-loading="true"] [data-nav-dashboard],
      html[data-auth-loading="true"] [data-nav-logout] {
        visibility: hidden;
      }
      html[data-authenticated="true"] [data-nav-login],
      html[data-authenticated="true"] [data-nav-register] {
        display: none !important;
      }
      html[data-authenticated="true"] [data-nav-dashboard],
      html[data-authenticated="true"] [data-nav-logout] {
        display: inline-flex !important;
      }
      html:not([data-authenticated="true"]) [data-nav-dashboard],
      html:not([data-authenticated="true"]) [data-nav-logout] {
        display: none !important;
      }
      body:not([data-role="ADMIN"]) [data-admin-only] {
        display: none !important;
      }
    </style>
    <script>
      document.documentElement.dataset.authLoading = "true";
    </script>
  </head>
  <body class="min-h-screen bg-sand-100 text-ink-900" data-api-base={apiBase}>
    <div class="min-h-screen bg-radiant">
      <SiteHeader isAuthenticated={hasAuthCookie} />
      <main class={`mx-auto w-full px-6 py-10 ${containerClass}`}>
        <slot />
      </main>
      <SiteFooter />
    </div>
    <script type="module">
      const apiBase =
        document.body?.dataset?.apiBase || "http://localhost:3000/api/v1";
      const dashboardLink = document.querySelector("[data-nav-dashboard]");
      const loginLink = document.querySelector("[data-nav-login]");
      const registerLink = document.querySelector("[data-nav-register]");
      const logoutButton = document.querySelector("[data-nav-logout]");
      const setAuthLinks = (isAuthenticated) => {
        if (dashboardLink) {
          dashboardLink.hidden = !isAuthenticated;
          dashboardLink.style.display = isAuthenticated
            ? "inline-flex"
            : "none";
        }
        if (loginLink) {
          loginLink.hidden = isAuthenticated;
          loginLink.style.display = isAuthenticated ? "none" : "inline-flex";
        }
        if (registerLink) {
          registerLink.hidden = isAuthenticated;
          registerLink.style.display = isAuthenticated ? "none" : "inline-flex";
        }
        if (logoutButton) {
          logoutButton.hidden = !isAuthenticated;
          logoutButton.style.display = isAuthenticated ? "inline-flex" : "none";
        }
      };
      const setAuthState = (isAuthenticated, role) => {
        document.documentElement.dataset.authenticated = isAuthenticated
          ? "true"
          : "false";
        document.documentElement.dataset.authLoading = "false";
        if (isAuthenticated && role) {
          document.body.dataset.role = role;
          document.documentElement.dataset.role = role;
        } else {
          delete document.body.dataset.role;
          delete document.documentElement.dataset.role;
        }
        setAuthLinks(isAuthenticated);
      };
      const readAuthHint = () => {
        try {
          return localStorage.getItem("auth") === "true";
        } catch {
          return false;
        }
      };
      const writeAuthHint = (value) => {
        try {
          if (value) {
            localStorage.setItem("auth", "true");
          } else {
            localStorage.removeItem("auth");
          }
        } catch {
          // ignore storage errors
        }
      };
      document.documentElement.dataset.authLoading = "true";
      const cookieAuth =
        document.documentElement.dataset.authenticated === "true";
      const authHint = readAuthHint() || cookieAuth;
      setAuthState(authHint);
      fetch(`${apiBase}/auth/me`, { credentials: "include", cache: "no-store" })
        .then((response) =>
          response.ok
            ? response.json()
            : Promise.resolve({ __status: response.status }),
        )
        .then((user) => {
          if (user && !user.__status) {
            setAuthState(true, user.role);
            writeAuthHint(true);
            return;
          }
          const status = user?.__status;
          if (status === 401 || status === 403) {
            setAuthState(false);
            writeAuthHint(false);
          }
        })
        .catch(() => {
          // keep last known state on network errors
        });
      if (logoutButton) {
        logoutButton.addEventListener("click", async () => {
          try {
            await fetch(`${apiBase}/auth/logout`, {
              method: "POST",
              credentials: "include",
            });
          } catch {
            // ignore network errors
          }
          writeAuthHint(false);
          window.location.href = "/login";
        });
      }
    </script>
  </body>
</html>
